# Set user or root password (hashed)
# Usage: set-hashed-password [user|root]

TARGET="$1"
if [ -z "$TARGET" ]; then
  TARGET=$(@gum@ choose "user" "root")
fi

if [ "$TARGET" == "root" ]; then
  SECRET_KEY="unixRootPassword"
else
  SECRET_KEY="unixPassword"
fi

while true; do
  PASSWORD=$(@gum@ input --password --placeholder "Enter new password for $TARGET")
  if [ -z "$PASSWORD" ]; then
    echo "Password cannot be empty."
    continue
  fi
  CONFIRM=$(@gum@ input --password --placeholder "Confirm password")
  if [ "$PASSWORD" == "$CONFIRM" ]; then
    break
  fi
  echo "Passwords do not match. Try again."
done

echo "Hashing password..."
HASH=$(echo "$PASSWORD" | @mkpasswd@ --method=yescrypt --stdin)

# Set secret
# Encode to JSON string for sops --set
JSON_VALUE=$(@jq@ --null-input --arg v "$HASH" '$v')
EXTRACT_PATH='["'$SECRET_KEY'"]'

echo "Setting $SECRET_KEY..."
@sops@ --set "$EXTRACT_PATH $JSON_VALUE" secrets.yaml

echo "Sorting secrets.yaml..."
export EDITOR="@yq@ --inplace 'sort_keys(..)'"
@sops@ edit secrets.yaml

echo "Password for $TARGET updated."
