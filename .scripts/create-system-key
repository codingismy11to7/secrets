# Create a new system age key and encrypt it
# Usage: create-system-key

@gum@ confirm "WARNING: This will overwrite 'keys.txt.age' AND DELETE 'secrets.yaml'. ALL EXISTING SECRETS WILL BE LOST. Continue?" || exit 0

echo "Generating new system age key..."
TMP_KEY=$(mktemp -u)
@ageKeygen@ --output "$TMP_KEY"

# Derive public key for .sops.yaml
AGE_PUB_KEY=$(@ageKeygen@ -y "$TMP_KEY")

echo "Encrypting new key to keys.txt.age..."
echo "You will be prompted to enter a passphrase to protect this key."
echo "This passphrase will only be requested when deploying the key to the system."
echo "Please ensure it is strong."
@age@ --passphrase --armor --output keys.txt.age "$TMP_KEY"

# We keep TMP_KEY for a moment to compare? No, ensure-system-key-exists decrypts keys.txt.age.
# But we need the public key for .sops.yaml.

rm "$TMP_KEY"
echo
echo "New system key created at keys.txt.age."
echo
echo "Ensuring system key is installed..."
ensure-system-key-exists

# Delete .sops.yaml if it exists, as we'll use command line arguments
if [ -f ".sops.yaml" ]; then
    echo "Removing .sops.yaml..."
    rm ".sops.yaml"
fi

echo
echo "Recreating secrets.yaml (previous secrets are lost)..."
rm -f secrets.yaml

# Initialize new secrets.yaml using the public key directly
echo "Initializing secrets.yaml with age recipient $AGE_PUB_KEY..."
echo "{}" | @sops@ --encrypt --age "$AGE_PUB_KEY" --filename-override secrets.yaml --input-type json --output-type yaml --output secrets.yaml /dev/stdin

echo
echo "Please set the User password:"
set-hashed-password user

echo
echo "Please set the Root password:"
set-hashed-password root

echo
echo "Please setup the SSH key:"
generate-ssh-key --yes
