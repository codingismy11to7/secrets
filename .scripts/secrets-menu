# Interactive secrets menu using gum

while true; do
  CHOICE=$(@gum@ choose "List Secrets" "Print Secret" "Copy Secret to Clipboard" "Extract Public Key" "Deploy Key to Remote Server" "Ensure System Key Exists" "Exit")

  case "$CHOICE" in
    "List Secrets")
      list-secrets
      echo
      echo "Press any key to return to menu..."
      read -n 1 -s -r
      ;;
    "Print Secret")
      SECRETS=$(list-secrets)
      SECRET=$(echo "$SECRETS" | @gum@ filter --placeholder "Select a secret to print...")
      if [ -n "$SECRET" ]; then
        print-secret "$SECRET"
        echo
        echo
        echo "Press any key to return to menu..."
        read -n 1 -s -r
      fi
      ;;
    "Copy Secret to Clipboard")
      SECRETS=$(list-secrets)
      SECRET=$(echo "$SECRETS" | @gum@ filter --placeholder "Select a secret to copy...")
      if [ -n "$SECRET" ]; then
        # We assume print-secret outputs only the secret value (which it does via sops --extract)
        # Note: sops extraction might include a trailing newline. wl-copy usually handles it or we can trim.
        # But print-secret runs sops output directly.
        print-secret "$SECRET" | @wlCopy@
        echo "Secret '$SECRET' copied to clipboard."
        echo
        echo "Press any key to return to menu..."
        read -n 1 -s -r
      fi
      ;;
    "Extract Public Key")
      extract-pub-key secrets.yaml "sshPrivKey"
      echo
      echo
      echo "Press any key to return to menu..."
      read -n 1 -s -r
      ;;
    "Deploy Key to Remote Server")
      deploy-pub-key
      echo
      echo
      echo "Press any key to return to menu..."
      read -n 1 -s -r
      ;;
    "Ensure System Key Exists")
      ensure-system-key-exists
      echo
      echo
      echo "Press any key to return to menu..."
      read -n 1 -s -r
      ;;
    "Exit")
      exit 0
      ;;
  esac
done
