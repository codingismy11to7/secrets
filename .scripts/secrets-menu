# Interactive secrets menu using gum

# Interactive secrets menu using gum

function secrets_submenu() {
  while true; do
    CHOICE=$(@gum@ choose "List Secrets" "Print Secret" "Set Secret" "Remove Secret" "Copy Secret to Clipboard" "Edit Secrets" "Back")

    case "$CHOICE" in
      "List Secrets")
        list-secrets
        echo
        echo "Press any key to return to menu..."
        read -n 1 -s -r
        ;;
      "Print Secret")
        SECRETS=$(list-secrets)
        SECRET=$(echo "$SECRETS" | @gum@ filter --placeholder "Select a secret to print...")
        if [ -n "$SECRET" ]; then
          print-secret "$SECRET"
          echo
          echo
          echo "Press any key to return to menu..."
          read -n 1 -s -r
        fi
        ;;
      "Set Secret")
        set-secret
        echo
        echo
        echo "Press any key to return to menu..."
        read -n 1 -s -r
        ;;
      "Remove Secret")
        remove-secret
        echo
        echo
        echo "Press any key to return to menu..."
        read -n 1 -s -r
        ;;
      "Copy Secret to Clipboard")
        SECRETS=$(list-secrets)
        SECRET=$(echo "$SECRETS" | @gum@ filter --placeholder "Select a secret to copy...")
        if [ -n "$SECRET" ]; then
          print-secret "$SECRET" | @wlCopy@
          echo "Secret '$SECRET' copied to clipboard."
          echo
          echo "Press any key to return to menu..."
          read -n 1 -s -r
        fi
        ;;
      "Edit Secrets")
        @sops@ edit secrets.yaml
        ;;
      "Back")
        return
        ;;
    esac
  done
}

function ssh_key_submenu() {
  while true; do
    CHOICE=$(@gum@ choose "Extract Public Key" "Deploy Key to Remote Server" "Add/Recreate SSH key" "Back")

    case "$CHOICE" in
      "Extract Public Key")
        extract-pub-key secrets.yaml "sshPrivKey"
        echo
        echo
        echo "Press any key to return to menu..."
        read -n 1 -s -r
        ;;
      "Deploy Key to Remote Server")
        deploy-pub-key
        echo
        echo
        echo "Press any key to return to menu..."
        read -n 1 -s -r
        ;;
      "Add/Recreate SSH key")
        generate-ssh-key
        echo
        echo
        echo "Press any key to return to menu..."
        read -n 1 -s -r
        ;;
      "Back")
        return
        ;;
    esac
  done
}

while true; do
  CHOICE=$(@gum@ choose "Manage Secrets" "Manage SSH Key" "Ensure System Key Exists" "Exit")

  case "$CHOICE" in
    "Manage Secrets")
      secrets_submenu
      ;;
    "Manage SSH Key")
      ssh_key_submenu
      ;;
    "Ensure System Key Exists")
      ensure-system-key-exists
      echo
      echo
      echo "Press any key to return to menu..."
      read -n 1 -s -r
      ;;
    "Exit")
      exit 0
      ;;
  esac
done
