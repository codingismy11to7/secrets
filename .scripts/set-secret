# Set a secret in sops file
# Usage: set-secret [sops_file]

SOPS_FILE="${1:-secrets.yaml}"

if [ ! -f "$SOPS_FILE" ]; then
  echo "Error: $SOPS_FILE not found."
  exit 1
fi

echo "Enter Secret Name:"
KEY_NAME=$(@gum@ input --placeholder "Secret Name")

if [ -z "$KEY_NAME" ]; then
  echo "Secret Name is required."
  exit 1
fi

echo "Enter Secret Value:"
VALUE=$(@gum@ write --placeholder "Secret Value")

if [ -z "$VALUE" ]; then
  echo "Secret Value is required."
  exit 1
fi

# Encode value to JSON string for sops --set
JSON_VALUE=$(@jq@ --null-input --arg v "$VALUE" '$v')

# Construct path
EXTRACT_PATH='["'$KEY_NAME'"]'

echo "Setting secret '$KEY_NAME'..."
# sops --set expects "path value" as a single argument string
# value must be JSON encoded
@sops@ --set "$EXTRACT_PATH $JSON_VALUE" "$SOPS_FILE"

echo "Sorting keys alphabetically..."
# Use yq to sort keys via sops edit mechanism
# We set EDITOR to run yq in-place
export EDITOR="@yq@ --inplace 'sort_keys(..)'"
@sops@ edit "$SOPS_FILE"
