
# Color definitions (ANSI escape codes)
GREEN='\033[0;32m'
YELLOW_BOLD='\033[1;33m'
CYAN='\033[0;36m'
RED_BOLD='\033[1;31m'
NC='\033[0m' # No Color

SYSTEM_KEY_FILE="@systemKeyFile@"

# Default values
FORCE=false

# Help function
show_help() {
  echo "Usage: $(basename "$0") [OPTIONS]"
  echo
  echo "Decrypts and installs the sops age key to the system location."
  echo
  echo "Options:"
  echo "  -h, --help       Show this help message and exit"
  echo "  -f, --force      Overwrite the key file if it already exists"
  echo
}

# Parse arguments
while [ "$#" -gt 0 ]; do
  case "$1" in
  -h | --help)
    show_help
    exit 0
    ;;
  -f | --force)
    FORCE=true
    shift
    ;;
  *)
    echo "Unknown option: $1"
    show_help
    exit 1
    ;;
  esac
done

# Main Logic

# Check if key exists
if [ -f "$SYSTEM_KEY_FILE" ]; then
  if [ "$FORCE" = true ]; then
    printf "${YELLOW_BOLD}‚ö†Ô∏è  Force mode enabled. Overwriting existing key at $SYSTEM_KEY_FILE.${NC}\n"
  else
    printf "${GREEN}‚úì System master key already exists at $SYSTEM_KEY_FILE${NC}\n"
    exit 0
  fi
else
  printf "${YELLOW_BOLD}üîí System master key not found at $SYSTEM_KEY_FILE${NC}\n"
fi

echo "We need to decrypt the master key to unlock your secrets."
echo

printf "${CYAN}Please enter your passphrase when prompted by ${YELLOW_BOLD}age${CYAN}...${NC}\n"

# Create a temporary file for the decrypted key
TMP_KEY=$(mktemp) || {
  echo "Failed to create temp file"
  exit 1
}

# Check for keys.txt.age in current directory
AGE_FILE="./keys.txt.age"
if [ ! -f "$AGE_FILE" ]; then
  printf "${RED_BOLD}‚úó Could not find encrypted key file at $AGE_FILE${NC}\n"
  rm -f "$TMP_KEY"
  exit 1
fi

# Run age via nix run to decrypt to the temp file
if @age@ -d -o "$TMP_KEY" "$AGE_FILE"; then
  echo
  printf "${GREEN}‚úì Successfully decrypted key to temporary file.${NC}\n"

  printf "${CYAN}Installing master key to system location ($SYSTEM_KEY_FILE)...${NC}\n"

  # Install to system location with sudo
  if sudo mkdir -p "$(dirname "$SYSTEM_KEY_FILE")" &&
    sudo cp "$TMP_KEY" "$SYSTEM_KEY_FILE" &&
    sudo chown root:wheel "$SYSTEM_KEY_FILE" &&
    sudo chmod 440 "$SYSTEM_KEY_FILE"; then
    printf "${GREEN}‚úì Successfully installed key to system location!${NC}\n"
  else
    printf "${RED_BOLD}‚úó Failed to install key to system location.${NC}\n"
    rm -f "$TMP_KEY"
    exit 1
  fi

  # Clean up temp file
  rm -f "$TMP_KEY"
else
  echo
  printf "${RED_BOLD}‚úó Decryption failed.${NC}\n"
  echo "Please check your passphrase and try again."
  rm -f "$TMP_KEY"
  exit 1
fi
