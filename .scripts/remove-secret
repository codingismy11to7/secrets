# Remove a secret from sops file
# Usage: remove-secret [secret_name] [sops_file]

KEY_NAME="$1"
SOPS_FILE="${2:-secrets.yaml}"

if [ ! -f "$SOPS_FILE" ]; then
  echo "Error: $SOPS_FILE not found."
  exit 1
fi

if [ -z "$KEY_NAME" ]; then
  echo "Fetching secrets list..."
  # list-secrets should be in PATH
  SECRETS=$(list-secrets)
  KEY_NAME=$(echo "$SECRETS" | @gum@ filter --placeholder "Select secret to remove")
fi

if [ -z "$KEY_NAME" ]; then
  echo "No secret selected."
  exit 1
fi

# Confirm removal
if @gum@ confirm "Are you sure you want to remove '$KEY_NAME'?"; then
  # Construct path
  EXTRACT_PATH='["'$KEY_NAME'"]'

  echo "Removing secret '$KEY_NAME'..."
  # Use yq to delete key via sops edit mechanism
  # Construct yq path: .["key"]
  # We construct the EDITOR command carefully to handle spaces
  
  # YQ expression: del(.["key"])
  # We wrap the expression in single quotes for yq.
  # We wrap the key in double quotes inside brackets.
  
  export EDITOR="@yq@ --inplace 'del(.[\"$KEY_NAME\"])'"
  @sops@ edit "$SOPS_FILE"
else
  echo "Cancelled."
  exit 0
fi
